trigger:
- main

pool:
  name: agent_name

# Step 1 - Installs maven dependencies
steps:
- script: mvn clean install
  displayName: '1.Build project'

# Skip the run process
# - script: java -jar target\Christmas-0.0.1-SNAPSHOT.jar
#   displayName: 'Run application'

# Step 2 - Copy the build to workingDirectory
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(System.DefaultWorkingDirectory)\target'
    Contents: 'Christmas-0.0.1-SNAPSHOT.jar'
    TargetFolder: 'C:\Users\ruser\Downloads\$(Build.BuildNumber)'
    OverWrite: true
  displayName: '2.Copy JAR to shared folder'

# Step 3 - Copy the build to remote AWS linux machine
- script: scp -i "key.pem" "Christmas-0.0.1-SNAPSHOT.jar" user@IP_address:/home/user
  workingDirectory: 'C:\Users\ruser\Downloads'
  displayName: '3.Copy to remote machine'

# Skipping kill process - kills application running in 8080
# - script: |
#       ssh -i "key.pem" ubuntu@IP_address "PID=$(lsof -ti tcp:8080)"
#       ssh -i "key.pem" ubuntu@IP_address "kill -9 $PID" 
#   workingDirectory: 'C:\Users\ruser\Downloads'
#   displayName: '4. kill process'

# Step 4 - Deploy to remote AWS machine
- script: ssh -i "key.pem" user@IP_address "nohup java -jar deva/Christmas-0.0.1-SNAPSHOT.jar > output.log 2>&1 &"
  workingDirectory: 'C:\Users\ruser\Downloads'
  displayName: '5.deploy'