trigger:
- main

pool:
  name: agent_name

jobs:
# -------------------
# Job 1: Build
# -------------------
- job: Build
  displayName: 'Build Job'
  steps:
    - script: python --version
      displayName: 'Check Python version'

    - script: pip --version
      displayName: 'Check pip version'

    # Optional: install dependencies
    # - script: pip install -r requirements.txt
    #   displayName: 'Install dependencies'

    # Create artifact
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)'
        Contents: 'python_app_build_1.py'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        OverWrite: true
      displayName: 'Copied to Artifact server'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'
        publishLocation: 'Container'
      displayName: 'Publish Python app artifact'

# -------------------
# Job 2: Deploy
# -------------------
- job: Deploy
  displayName: 'Deploy Job'
  dependsOn: Build
  steps:
    # Step 3: Run Python app ver 1
    - script: python python_app_build_1.py
      displayName: 'Deploys Build ver 1'

    # Step 4: Delay
    - script: |
        echo "Waiting for 10 seconds..."
        timeout /t 10 /nobreak
      displayName: 'Wait before killing build'

    # Step 5: Kill process on port 8000
    - script: for /f "tokens=5" %a in ('netstat -ano ^| findstr :8000') do taskkill /PID %a /F
      displayName: 'Kills Build ver 1'

    # Step 6: Run Python app ver 2
    - script: python python_app_build_2.py
      displayName: 'Deploys Build ver 2'

    # Step 7: Fallback if Build ver 2 fails
    - script: python python_app_build_1.py
      displayName: 'Fall back to Build ver 1 due to ver 2 failure'
      condition: failed()